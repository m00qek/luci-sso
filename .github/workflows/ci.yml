name: CI (Consumer)

on:
  push:
    branches: [main, master, ci]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "LICENSE"

env:
  REGISTRY: ghcr.io
  DOCKER_SUITE: ci

jobs:
  test:
    name: Run Verification Suite
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      #      - name: Get Project Variables
      #        id: vars
      #        run: |
      #          # Use --no-print-directory and xargs to ensure perfectly clean strings
      #          VERSION=$(make -s --no-print-directory -C devenv print-env VAR=SDK_VERSION | xargs)
      #          NODE_V=$(make -s --no-print-directory -C devenv print-env VAR=NODE_VERSION | xargs)
      #          ALPINE_V=$(make -s --no-print-directory -C devenv print-env VAR=ALPINE_VERSION | xargs)
      #          ARCH="x86-64"
      #          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
      #
      #          echo "sdk_version=$VERSION" >> $GITHUB_OUTPUT
      #          echo "sdk_arch=$ARCH" >> $GITHUB_OUTPUT
      #          echo "node_tag=node${NODE_V}-alpine${ALPINE_V}" >> $GITHUB_OUTPUT
      #          echo "alpine_tag=alpine${ALPINE_V}" >> $GITHUB_OUTPUT
      #          echo "repo_owner=$OWNER" >> $GITHUB_OUTPUT
      #
      #          # Export to ENV to ensure ALL subsequent make calls use the same project identity
      #          echo "SDK_ARCH=$ARCH" >> $GITHUB_ENV
      #
      #      - name: Log in to the Container registry
      #        uses: docker/login-action@v3
      #        with:
      #          registry: ${{ env.REGISTRY }}
      #          username: ${{ github.actor }}
      #          password: ${{ secrets.GITHUB_TOKEN }}
      #
      #      - name: Warm Docker Cache (Pull Images)
      #        run: |
      #          IMAGE_BASE="${{ env.REGISTRY }}/${{ steps.vars.outputs.repo_owner }}/luci-sso"
      #          SDK_TAG="${{ steps.vars.outputs.sdk_arch }}-${{ steps.vars.outputs.sdk_version }}"
      #          NODE_TAG="${{ steps.vars.outputs.node_tag }}"
      #          ALPINE_TAG="${{ steps.vars.outputs.alpine_tag }}"
      #
      #          # Only pull if they exist to prevent workflow failure if factory hasn't run
      #          docker pull $IMAGE_BASE-openwrt:$SDK_TAG || true
      #          docker pull $IMAGE_BASE-idp:$NODE_TAG || true
      #          docker pull $IMAGE_BASE-browser:$NODE_TAG || true
      #          docker pull $IMAGE_BASE-pki:$ALPINE_TAG || true
      #
      #          # Tag them locally to match exactly what docker-compose expects
      #          # Note: We skip SDK here as it is temporarily disabled in the Factory
      #          docker tag $IMAGE_BASE-openwrt:$SDK_TAG luci-sso-openwrt:$SDK_TAG || true
      #          docker tag $IMAGE_BASE-idp:$NODE_TAG luci-sso-idp:$NODE_TAG || true
      #          docker tag $IMAGE_BASE-browser:$NODE_TAG luci-sso-browser:$NODE_TAG || true
      #          docker tag $IMAGE_BASE-pki:$ALPINE_TAG luci-sso-pki:$ALPINE_TAG || true

      - name: Start Environment
        run: make -sC devenv up DETACHED=true

      - name: Run Unit Tests
        run: make -sC devenv unit-test

      - name: Run E2E Tests
        run: make -sC devenv e2e-test

      - name: Stop Environment
        if: always()
        run: make -sC devenv down
