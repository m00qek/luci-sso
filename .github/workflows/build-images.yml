name: Build Images (Factory)

on:
  push:
    branches: [main, master, ci]
    paths:
      - 'devenv/**'
      - 'Makefile'
      - '.github/workflows/build-images.yml'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild of all images'
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  metadata:
    name: Extract Metadata
    runs-on: ubuntu-latest
    outputs:
      pkg_depends: ${{ steps.vars.outputs.pkg_depends }}
      sdk_version: ${{ steps.vars.outputs.sdk_version }}
      sdk_arch: ${{ steps.vars.outputs.sdk_arch }}
      node_version: ${{ steps.vars.outputs.node_version }}
      alpine_version: ${{ steps.vars.outputs.alpine_version }}
      repo_owner: ${{ steps.vars.outputs.repo_owner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Project Variables
        id: vars
        run: |
          # Use the existing print-env interface from devenv/Makefile
          DEPENDS=$(make -s -C devenv print-env VAR=PKG_DEPENDS)
          VERSION=$(make -s -C devenv print-env VAR=SDK_VERSION)
          NODE_V=$(make -s -C devenv print-env VAR=NODE_VERSION)
          ALPINE_V=$(make -s -C devenv print-env VAR=ALPINE_VERSION)
          ARCH="x86-64" # Restricted to x86-64 as requested
          
          echo "pkg_depends=$DEPENDS" >> $GITHUB_OUTPUT
          echo "sdk_version=$VERSION" >> $GITHUB_OUTPUT
          echo "sdk_arch=$ARCH" >> $GITHUB_OUTPUT
          echo "node_version=$NODE_V" >> $GITHUB_OUTPUT
          echo "alpine_version=$ALPINE_V" >> $GITHUB_OUTPUT
          
          # Lowercase repo owner for Docker compatibility
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "repo_owner=$OWNER" >> $GITHUB_OUTPUT

  build-core:
    name: Build Core Images
    needs: metadata
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [sdk, openwrt]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: devenv/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ needs.metadata.outputs.repo_owner }}/luci-sso-${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ needs.metadata.outputs.repo_owner }}/luci-sso-${{ matrix.service }}:${{ needs.metadata.outputs.sdk_arch }}-${{ needs.metadata.outputs.sdk_version }}
          build-args: |
            SDK_ARCH=${{ needs.metadata.outputs.sdk_arch }}
            SDK_VERSION=${{ needs.metadata.outputs.sdk_version }}
            PKG_DEPENDS=${{ needs.metadata.outputs.pkg_depends }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-helpers:
    name: Build Helper Images
    needs: metadata
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [idp, browser, pki]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: devenv/services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ needs.metadata.outputs.repo_owner }}/luci-sso-${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ needs.metadata.outputs.repo_owner }}/luci-sso-${{ matrix.service }}:node${{ needs.metadata.outputs.node_version }}-alpine${{ needs.metadata.outputs.alpine_version }}
          build-args: |
            NODE_VERSION=${{ needs.metadata.outputs.node_version }}
            ALPINE_VERSION=${{ needs.metadata.outputs.alpine_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
