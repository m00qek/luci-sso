#!/usr/bin/ucode
import * as uci from 'uci';
import * as fs from 'fs';
import * as uclient from 'uclient';
import * as lucihttp from 'lucihttp';
import * as router from 'luci_sso.router';

// 1. Imperative Shell: Define the real I/O provider
const io = {
	time: time,
	read_file: (path) => fs.readfile(path),
	write_file: (path, data) => fs.writefile(path, data),
	http_get: (url) => {
		let conn = uclient.connect(url);
		if (!conn) return { error: "CONNECT_FAILED" };
		let res = conn.request("GET");
		conn.disconnect();
		return res;
	},
	http_post: (url, opts) => {
		let conn = uclient.connect(url);
		if (!conn) return { error: "CONNECT_FAILED" };
		if (opts.headers) {
			for (let k, v in opts.headers) conn.header(k, v);
		}
		let res = conn.request("POST", opts.body);
		conn.disconnect();
		return res;
	},
	urlencode: lucihttp.urlencode,
	getenv: getenv
};

// 2. Global Error Helper (CGI-style)
function cgi_die(msg, status) {
	print(`Status: ${status || 500}\n`);
	print(`Content-Type: text/plain\n\n`);
	print(`${msg}\n`);
	exit(1);
}

// 3. Load Configuration
const cursor = uci.cursor();
const config = cursor.get_all("luci-sso", "default");
if (!config) cgi_die("Configuration 'default' not found in /etc/config/luci-sso", 500);

const global_cfg = cursor.get_all("luci-sso", "globally");
if (!global_cfg || global_cfg.enabled !== '1') {
	cgi_die("SSO is disabled", 403);
}

// 4. Build Request Object
const request = {
	path: io.getenv("PATH_INFO") || "/",
	query_string: io.getenv("QUERY_STRING"),
	http_cookie: io.getenv("HTTP_COOKIE")
};

// 5. Functional Core: Delegate to Router
const res = router.handle(io, config, request);

// 6. Imperative Shell: Output Result
print(`Status: ${res.status}\n`);
for (let header in res.headers) {
	print(`${header}\n`);
}
print("\n");
print(res.body);
