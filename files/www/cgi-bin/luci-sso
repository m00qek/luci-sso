#!/usr/bin/ucode
import * as io_mod from 'luci_sso.io';
import * as web_mod from 'luci_sso.web';
import * as config_loader from 'luci_sso.config';
import * as router from 'luci_sso.router';
import * as Result from 'luci_sso.result';

const io = io_mod.create();

try {
	const res_req = web_mod.request(io);
	if (!res_req.ok) {
		let status = (type(res_req.details) == "object") ? res_req.details.http_status : 400;
		web_mod.render_error(io, res_req.error, status);
		exit(0);
	}

	const req = res_req.data;

	// W2: Allow ?action=enabled even if config loading fails with DISABLED
	const res_c = config_loader.load(io);
	if (!res_c.ok) {
		if (res_c.error == "DISABLED" && req.path == "/" && req.query.action == "enabled") {
			const res_router = router.handle(io, null, req);
			web_mod.render(io, res_router.data);
			exit(0);
		}
		web_mod.render_error(io, res_c.error, 500);
		exit(0);
	}

	const config = res_c.data;
	const res_router = router.handle(io, config, req);
	if (!res_router.ok) {
		let status = (type(res_router.details) == "object") ? res_router.details.http_status : 500;
		web_mod.render_error(io, res_router.error, status);
	} else {
		web_mod.render(io, res_router.data);
	}
} catch (e) {
	web_mod.error(io, e);
}
