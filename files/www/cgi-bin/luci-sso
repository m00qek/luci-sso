#!/usr/bin/ucode
import * as io_mod from 'luci_sso.io';
import * as web_mod from 'luci_sso.web';
import * as config_loader from 'luci_sso.config';
import * as router from 'luci_sso.router';
import * as Result from 'luci_sso.result';

const io = io_mod.create();

try {
	const res_c = config_loader.load(io);
	if (!res_c.ok) {
		web_mod.render_error(io, res_c.error, 500);
		exit(0);
	}

	const config = res_c.data;
	const res_req = web_mod.request(io);
	if (!res_req.ok) {
		web_mod.render_error(io, res_req.error, (res_req.error == "INPUT_TOO_LARGE") ? 431 : 400);
		exit(0);
	}

	const res_router = router.handle(io, config, res_req.data);
	if (!res_router.ok) {
		let status = (type(res_router.details) == "object") ? res_router.details.http_status : 500;
		web_mod.render_error(io, res_router.error, status);
	} else {
		web_mod.render(io, res_router.data);
	}
} catch (e) {
	web_mod.error(io, e);
}
